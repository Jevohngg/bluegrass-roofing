extends ../layouts/portalLayout

block pageStyles
  link(rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css")
  link(rel="stylesheet" href="/css/portal.css")

block content
  section.portal-section
    .portal-container
      // ---------- WELCOME -------------
      .portal-welcome
        h1 Welcome, #{userName}!
        p.portal-intro 
          | This is your personal client portal. Below are actions you can complete now 
          | to speed up the process while you wait for us to handle the rest.

      // ============ 2) SIGN CONTRACTS CONTAINER ============
      .portal-action-card
        h3 Sign Documents
        p.subtext 
          | Below are any documents that your contractor has sent you to sign.

        //– detect if the user self-signed an AOB without an admin send
        //– detect if the user self-signed an AOB without an admin send
        -
          const hasAutoAob = user.documents &&
            user.documents.aob &&
            user.documents.aob.signed &&
            !(docSends || []).some(ds => ds.docType === 'aob');
        

        //– render if any admin-sent docs or that self-signed AOB
        if (docSends && docSends.length) || hasAutoAob
          .doc-container-parent

            //–– loop admin-sent documents
            if docSends
              each ds in docSends
                - const docKey    = ds.docType
                - const docMeta   = user.documents && user.documents[docKey]
                - const isSigned  = docMeta && docMeta.signed
                - const signedUrl = docMeta && docMeta.docUrl
                - const signedAt  = docMeta && docMeta.signedAt

                .doc-card(class=(isSigned ? 'signed' : ''))
                  .doc-card-content
                    h4= docKey.toUpperCase()
                    if isSigned
                      - const formattedDate = new Date(signedAt).toLocaleString('en-US',{ dateStyle:'long', timeStyle:'short' })
                      p This document was signed on #{formattedDate}.
                    else
                      p This document is awaiting your signature.
                  .doc-card-actions
                    if isSigned
                      .doc-status-text
                        i.fas.fa-check-circle
                        | Signed
                      if signedUrl
                        a.btn.btn-secondary(href=signedUrl target="_blank")
                          i.fas.fa-file-download
                          | View/Download PDF
                    else
                      a.btn.btn-primary(href=`/portal/doc/${ds._id}`)
                        | Sign Now

            //–– append the auto AOB if needed
            if hasAutoAob
              - const docMeta   = user.documents.aob
              - const signedUrl = docMeta.docUrl
              - const signedAt  = docMeta.signedAt
              .doc-card.signed
                .doc-card-content
                  h4 AOB
                  - const formattedDate = new Date(signedAt).toLocaleString('en-US',{ dateStyle:'long', timeStyle:'short' })
                  p This document was signed on #{formattedDate}.
                .doc-card-actions
                  .doc-status-text
                    i.fas.fa-check-circle
                    | Signed
                  if signedUrl
                    a.btn.btn-secondary(href=signedUrl target="_blank")
                      i.fas.fa-file-download
                      | View/Download PDF

        else
          .action-state-success
            p No contracts to sign at this time.

      // ---------- PACKAGE INFO CARD -------------
      if packageName
        .portal-action-card.package-confirmation
          h2 Package: #{packageName}
          .package-confirmation-content
            i.fas.fa-check-circle.package-check-icon
            h3 Request Received!
            p 
              | We have received your package request and will reach out shortly with 
              | more information and next steps.
      else
        .portal-action-card
          h2 No Package Selected
          p 
            | You haven’t chosen a package yet.

      // ============ 1) UPLOAD CLAIM CONTAINER ============
      .portal-action-card(data-upload-claim) 
        h3 Upload Insurance Claim
        p.subtext 
          | If you already have a claim document from your insurance company, 
          | upload it here so we can expedite processing. If not, feel free to skip.

        if !user.claimUploadUrls || !user.claimUploadUrls.length
          .upload-claim-container
            .upload-dropzone#claimDropzone
              p Drop or click to select file(s) for upload
              input(type="file" id="claimFilesInput" name="claimFiles" accept=".pdf,.jpg,.png,.doc,.docx" multiple hidden)

            .upload-progress#uploadProgress(style="display:none;")
              .progress-bar#progressBar

            #attachedFilesContainer

            button.btn.btn-primary.btn-primary-disabled(type="button" id="submitFilesBtn" disabled)
              i.fas.fa-upload
              | Submit File(s)

          form#fallbackClaimForm(action="/portal/upload-claim" method="POST" enctype="multipart/form-data" style="display:none;")
            input#fallbackClaimFile(type="file" name="claimFile" accept=".pdf,.jpg,.png,.doc,.docx")
            button(type="submit") Upload
        else
          .action-state-success
            p Claim file(s) Uploaded Successfully.

          .uploaded-files-grid
            each fileUrl in user.claimUploadUrls
              .uploaded-file-preview(data-url=fileUrl)
                if /\.(jpg|jpeg|png|gif)$/i.test(fileUrl)
                  img(src=fileUrl alt="Preview of uploaded claim" loading="lazy")
                else
                  .file-icon
                    i.fas.fa-file
                  .file-name= fileUrl.split('/').pop()
                button.remove-preview-btn(type="button" aria-label=`Remove file at ${fileUrl}`) ×

          button.btn.btn-primary(type="button" id="uploadMoreBtn") 
            i.fas.fa-upload
            | Upload More

      // ============ 3) CHOOSE SHINGLE CONTAINER ============
      .portal-action-card
        h3 Choose a Shingle
        p.subtext
          | We offer a variety of shingle options. Please choose one below.

        if user.shingleChoice.name
          .action-state-success
            p 
              | You selected: "#{user.shingleChoice.name}"
          .container
            img.shingle-image(src=user.shingleChoice.imageUrl alt=user.shingleChoice.name)
            button.btn.btn-secondary(type="button" id="changeShingleBtn")
              i.fas.fa-edit
              | Change Shingle
        else
          button.btn.btn-primary#chooseShingleBtn
            i.fas.fa-cubes
            | Select Shingle

  // Bootstrap Delete Confirmation Modal
  .modal.fade#confirmDeleteModal(tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true")
    .modal-dialog(role="document")
      .modal-content
        .modal-header
          h5.modal-title#confirmDeleteModalLabel Confirm Deletion
          i.fas.fa-times#confirmDeleteModalCloseIcon.close-icon(aria-hidden="true")
        .modal-body
          p Are you sure you want to delete this file?
        .modal-footer
          button(type="button" class="btn btn-secondary" data-dismiss="modal") No
          button(type="button" class="btn btn-primary" id="confirmDeleteYes") Yes

  // ====== UPDATED SHINGLE MODAL WITH CUSTOM CLOSE ICON ======
  .modal.fade#shingleModal(tabindex="-1" role="dialog" aria-labelledby="shingleModalTitle" aria-hidden="true")
    .modal-dialog.modal-dialog-scrollable(role="document")
      .modal-content
        .modal-header
          h5.modal-title#shingleModalTitle Pick Your Shingle
          i.fas.fa-times#shingleModalCloseIcon.close-icon(aria-hidden="true")
        .modal-body
          p Select from the following options:
          .shingle-options
            each item in shingles
              .shingle-option
                .shingle-image-container
                  img.shingle-img(src=item.imageUrl alt=item.name)
                p= item.name
                form(action="/portal/select-shingle" method="POST")
                  input(type="hidden" name="shingleName" value=item.name)
                  input(type="hidden" name="shingleImageUrl" value=item.imageUrl)
                  button.btn.btn-primary(type="submit") Select
        .modal-footer
          button(type="button" class="btn btn-secondary" data-dismiss="modal") Cancel

block pageScripts
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script(src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js")
  script(src="/js/alert.js")
  script(src="/js/portal.js")

  // this one does the title swap
  script.
    (function(){
      const fullTitles = {
        'AOB': 'Assignment of Benefits (AOB)',
        'ACI': 'Authorization to Contact Insurer (ACI)',
        'LOI': 'Letter of Intent (LOI)',
        'GSA': 'General Service Agreement (GSA)',
        'COC': 'Certificate of Completion (COC)'
      };

      document.querySelectorAll('.doc-card-content h4').forEach(h4 => {
        const code = h4.textContent.trim();
        if (fullTitles[code]) {
          h4.textContent = fullTitles[code];
        }
      });
    })();
